<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ì´ë¯¸ì§€ ì—…ë¡œë“œ & ë‹¤ìš´ë¡œë“œ & ì‚­ì œ</title>

</head>

<body>
    <h2>Supabase ì´ë¯¸ì§€ ì—…ë¡œë“œ & ë‹¤ìš´ë¡œë“œ & ì‚­ì œ</h2>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <input type="file" id="fileInput">
    <button onclick="uploadImage()">ì—…ë¡œë“œ</button>

    <h3>ğŸ“¸ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ëª©ë¡</h3>
    <div id="imageList"></div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Supabase ì„¤ì •
    const supabaseUrl = "https://fsvilhpktvuyimkzgflu.supabase.co";
    const supabasePassword = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzdmlsaHBrdHZ1eWlta3pnZmx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0MjUwODgsImV4cCI6MjA1NTAwMTA4OH0.LU7A0fgqUj2eia-xunOWZYDuvfSvuM-a1_4V3TffXrI";
    const supabase = window.supabase.createClient(supabaseUrl, supabasePassword);
    const bucketName = "pmh"; // ì €ì¥ì†Œ ë²„í‚· ì´ë¦„

    // âœ… 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
    async function uploadImage() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
            alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }

        const fileExt = file.name.split(".").pop(); // í™•ì¥ì ì¶”ì¶œ
        const safeFileName = sanitizeFileName(file.name); // ì•ˆì „í•œ íŒŒì¼ ì´ë¦„ ë³€í™˜

        // Supabase Storage ì—…ë¡œë“œ
        const { data, error } = await supabase.storage
            .from(bucketName)
            .upload(safeFileName, file);

        if (error) {
            alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
            return;
        }

        alert("âœ… ì—…ë¡œë“œ ì„±ê³µ!");
        fileInput.value = ""; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        loadImages(); // ì´ë¯¸ì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }

    // âœ… 2. ì´ë¯¸ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadImages() {
        const res = await supabase.storage
            .from(bucketName)
            .list();
        const { data, error } = res;
        
        console.log(res);
        console.log(data);

        if (error) {
            console.error("ì´ë¯¸ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error.message);
            return;
        }

        const imageList = document.getElementById("imageList");
        imageList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        data.forEach(file => {
            const fileUrl = supabase.storage.from(bucketName).getPublicUrl(file.name).data.publicUrl;

            // ì´ë¯¸ì§€ ëª©ë¡ UI ì¶”ê°€
            const listItem = document.createElement("div");
            listItem.innerHTML = `
                <p>${file.name}</p>
                <a href="${fileUrl}" target="_blank">
                    <img src="${fileUrl}" width="150" alt="${file.name}">
                </a>
                <br>
                <button onclick="deleteImage('${file.name}')">ì‚­ì œ</button>
            `;
            imageList.appendChild(listItem);
        });
    }

    // âœ… 3. ì´ë¯¸ì§€ ì‚­ì œ
    async function deleteImage(fileName) {
        const { error } = await supabase.storage
            .from(bucketName)
            .remove([fileName]);

        if (error) {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
            return;
        }

        alert("ğŸ—‘ï¸ ì‚­ì œ ì„±ê³µ!");
        loadImages(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    window.addEventListener("DOMContentLoaded", function () {
        loadImages(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    });

    // ì‚­ì œ í•¨ìˆ˜ ì „ì—­ ë“±ë¡ (HTML ë²„íŠ¼ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡)
    window.deleteImage = deleteImage;

    function sanitizeFileName(fileName) {
        return fileName
            .replace(/\s+/g, "_") // ê³µë°±ì„ ì–¸ë”ìŠ¤ì½”ì–´(_)ë¡œ ë³€ê²½
            .replace(/[^\w.-]/g, "") // í•œê¸€ ë° íŠ¹ìˆ˜ ë¬¸ì ì œê±°
            .toLowerCase(); // ì†Œë¬¸ìë¡œ ë³€í™˜ (ê¶Œì¥)
    }

</script>